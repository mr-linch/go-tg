# go-tg-gen configuration.
parser:
  enums:
    # Field-mapped: values from first field's auto-detected Enum
    - name: ChatType
      fields: [Chat.type, ChatFullInfo.type, InlineQuery.chat_type]
    - name: StickerType
      fields: [Sticker.type, StickerSet.sticker_type]
    - name: MessageEntityType
      fields: [MessageEntity.type]

    # Expr-computed: structural enums
    - name: UpdateType
      expr: 'filter(Fields("Update"), {.Optional}) | map({.Name})'
    - name: MessageType
      expr: 'filter(Fields("Message"), {.Optional}) | map({.Name})'
      exclude:
        - message_thread_id
        - direct_messages_topic
        - from
        - sender_chat
        - sender_boost_count
        - sender_business_bot
        - business_connection_id
        - forward_origin
        - is_topic_message
        - is_automatic_forward
        - reply_to_message
        - external_reply
        - quote
        - reply_to_story
        - reply_to_checklist_task_id
        - via_bot
        - edit_date
        - has_protected_content
        - is_from_offline
        - is_paid_post
        - media_group_id
        - author_signature
        - paid_star_count
        - entities
        - link_preview_options
        - suggested_post_info
        - effect_id
        - caption
        - caption_entities
        - show_caption_above_media
        - has_media_spoiler
        - reply_markup

    # Method parameter enums
    - name: ChatAction
      expr: 'ParamEnumValues("sendChatAction", "action")'

    # Expr-computed: union discriminator enums
    - name: MessageOriginType
      expr: 'SubtypeConsts("MessageOrigin", "type")'
    - name: ChatMemberStatus
      expr: 'SubtypeConsts("ChatMember", "status")'
    - name: BackgroundFillType
      expr: 'SubtypeConsts("BackgroundFill", "type")'
    - name: ReactionTypeType
      expr: 'SubtypeConsts("ReactionType", "type")'
    - name: BotCommandScopeType
      expr: 'SubtypeConsts("BotCommandScope", "type")'
    - name: MenuButtonType
      expr: 'SubtypeConsts("MenuButton", "type")'
    - name: InlineQueryResultType
      expr: 'SubtypeConsts("InlineQueryResult", "type")'
    - name: InputMediaType
      expr: 'SubtypeConsts("InputMedia", "type")'

    # Field-mapped: standalone enums
    - name: PollType
      fields: [Poll.type]
    - name: MaskPositionPoint
      fields: [MaskPosition.point]
    - name: EncryptedPassportElementType
      fields: [EncryptedPassportElement.type]
    - name: StickerFormat
      fields: [InputSticker.format]
    - name: Currency
      fields: [SuggestedPostPaid.currency, SuggestedPostPrice.currency]
    - name: TransactionPartnerUserTransactionTypeEnum
      fields: [TransactionPartnerUser.transaction_type]

    # Field-mapped: button modifiers
    - name: ButtonStyle
      fields: [KeyboardButton.style, InlineKeyboardButton.style]
    - name: UniqueGiftModelRarity
      fields: [UniqueGiftModel.rarity]

    # Emoji-based enums (resolved via gomoji)
    - name: DiceEmoji
      expr: 'ParamEnumValues("sendDice", "emoji")'
    - name: ReactionEmoji
      fields: [ReactionTypeEmoji.emoji]

typegen:
  enums:
    - name: ChatType
      underlying: int8
      marshal: json
    - name: StickerType
      underlying: int8
      marshal: text
      unknown: true
    - name: MessageEntityType
      underlying: int8
      marshal: text
      unknown: true
    - name: UpdateType
      underlying: int8
      marshal: text
      unknown: true
    - name: ChatAction
      underlying: int8
      marshal: stringer
    - name: MessageType
      underlying: int8
      marshal: none
      unknown: true
    - name: PollType
      underlying: int8
      marshal: text
      unknown: true
    - name: MaskPositionPoint
      underlying: int8
      marshal: text
    - name: EncryptedPassportElementType
      underlying: int8
      marshal: text
      unknown: true
    - name: StickerFormat
      underlying: int8
      marshal: text
      unknown: true
    - name: Currency
      underlying: int8
      marshal: text
      unknown: true
    - name: TransactionPartnerUserTransactionTypeEnum
      underlying: int8
      marshal: text
      unknown: true
    - name: DiceEmoji
      underlying: int8
      marshal: text
      unknown: true
    - name: ButtonStyle
      underlying: int8
      marshal: text
      unknown: true
    - name: UniqueGiftModelRarity
      underlying: int8
      marshal: text
      unknown: true
    - name: ReactionEmoji
      underlying: int8
      marshal: text
      unknown: true

  type_methods:
    - type: Update
      method: Type
      return: UpdateType
    - type: Message
      method: Type
      return: MessageType

  exclude:
    # Description-only types with custom implementations
    - InputFile
    # Union types without const discriminator (manual unmarshal logic)
    - MaybeInaccessibleMessage

  # Interface unions: marker interface pattern for union types without a JSON discriminator.
  # Spec-derived unions (e.g., InputMessageContent) are auto-detected; config-defined ones are listed here.
  interface_unions:
    - name: ReplyMarkup
      variants:
        - InlineKeyboardMarkup
        - ReplyKeyboardMarkup
        - ReplyKeyboardRemove
        - ForceReply

  field_type_rules:
    - expr: 'TypeExpr.Types[0].Type in ["Integer", "Integer64"] && (Description contains "Unix time" || Description contains "Unix timestamp")'
      type: UnixTime
      scalar: true
    - expr: '(Name == "file_id" || hasSuffix(Name, "_file_id")) && TypeExpr.Types[0].Type == "String"'
      type: FileID
      scalar: true
    - expr: '(Name == "chat_id" || hasSuffix(Name, "_chat_id")) && TypeExpr.Types[0].Type in ["Integer", "Integer64"]'
      type: ChatID
      scalar: true
    - expr: '(Name == "user_id" || hasSuffix(Name, "_user_id")) && TypeExpr.Types[0].Type in ["Integer", "Integer64"]'
      type: UserID
      scalar: true
    - expr: 'hasSuffix(Name, "parse_mode")'
      type: ParseMode
      scalar: true
    - expr: '(Name == "username" || hasSuffix(Name, "_username")) && TypeExpr.Types[0].Type == "String"'
      type: Username
      scalar: true
    - expr: 'TypeExpr.Types[0].Type == "String" && Description contains "file_id" && Description contains "attach://"'
      type: FileArg
    - expr: 'TypeExpr.Types[0].Type == "String" && !(Description contains "file_id") && Description contains "attach://"'
      type: InputFile

  name_overrides:
    Update.update_id: ID
    Message.message_id: ID
    Contact.vcard: VCard
    InlineQueryResultContact.vcard: VCard
    InputContactMessageContent.vcard: VCard

  type_overrides:
    User.id: UserID
    Chat.id: ChatID
    Chat.type: ChatType
    ChatFullInfo.id: ChatID
    ChatFullInfo.type: ChatType
    InaccessibleMessage.date: UnixTime
    MessageEntity.type: MessageEntityType
    Sticker.type: StickerType
    StickerSet.sticker_type: StickerType
    InlineQuery.chat_type: ChatType
    WebhookInfo.allowed_updates: "[]UpdateType"
    Poll.type: PollType
    KeyboardButtonPollType.type: PollType
    MaskPosition.point: MaskPositionPoint
    EncryptedPassportElement.type: EncryptedPassportElementType
    InputSticker.format: StickerFormat
    SuggestedPostPaid.currency: Currency
    SuggestedPostPrice.currency: Currency
    TransactionPartnerUser.transaction_type: TransactionPartnerUserTransactionTypeEnum
    ForumTopic.icon_color: TopicIconColor
    ForumTopicCreated.icon_color: TopicIconColor
    Dice.emoji: DiceEmoji
    ReactionTypeEmoji.emoji: ReactionEmoji
    KeyboardButton.style: ButtonStyle
    InlineKeyboardButton.style: ButtonStyle
    UniqueGiftModel.rarity: UniqueGiftModelRarity

  # Variant constructors for types with mutually exclusive optional fields
  variant_constructors:
    - type: InlineKeyboardButton
      base_field: text
      exclude: [icon_custom_emoji_id, style]
      defaults:
        pay: "true"
        callback_game: "&CallbackGame{}"

    - type: KeyboardButton
      base_field: text
      include_base: true
      exclude: [icon_custom_emoji_id, style]
      defaults:
        request_contact: "true"
        request_location: "true"

    - type: InlineQueryResultsButton
      base_field: text

methodgen:
  stringer_types:
    - ParseMode
    - ChatAction
    - DiceEmoji

  param_type_rules:
    # PeerID: chat_id or *_chat_id with Integer or String union (accepts both int and username)
    - expr: '(Name == "chat_id" || hasSuffix(Name, "_chat_id")) && len(TypeExpr.Types) > 1'
      type: PeerID
    # UserID: user_id or *_user_id with Integer type
    - expr: '(Name == "user_id" || hasSuffix(Name, "_user_id")) && TypeExpr.Types[0].Type in ["Integer", "Integer64"]'
      type: UserID
    # FileID: file_id or *_file_id with String type
    - expr: '(Name == "file_id" || hasSuffix(Name, "_file_id")) && TypeExpr.Types[0].Type == "String"'
      type: FileID
    # FileArg: InputFile type with description mentioning "file_id" (can pass file_id, URL, or upload)
    - expr: 'TypeExpr.Types[0].Type == "InputFile" && Description contains "file_id"'
      type: FileArg
    # InputFile: InputFile type without "file_id" mention (upload only)
    - expr: 'TypeExpr.Types[0].Type == "InputFile" && !(Description contains "file_id")'
      type: InputFile
    # ParseMode
    - expr: 'Name == "parse_mode"'
      type: ParseMode
    # Reply markup union -> ReplyMarkup interface
    - expr: 'Name == "reply_markup" && len(TypeExpr.Types) > 1'
      type: ReplyMarkup

  param_type_overrides:
    sendChatAction.action: ChatAction
    getUpdates.allowed_updates: "[]UpdateType"
    setWebhook.allowed_updates: "[]UpdateType"
    sendDice.emoji: DiceEmoji
    createForumTopic.icon_color: TopicIconColor

  return_type_overrides:
    stopPoll: Poll

  # Methods with mutually exclusive required params need multiple constructors
  # Each variant can specify its own return_type
  constructor_variants:
    editMessageText:
      - suffix: ""
        required_params: [chat_id, message_id, text]
        return_type: Message
      - suffix: "Inline"
        required_params: [inline_message_id, text]
        return_type: True
    editMessageCaption:
      - suffix: ""
        required_params: [chat_id, message_id, caption]
        return_type: Message
      - suffix: "Inline"
        required_params: [inline_message_id, caption]
        return_type: True
    editMessageMedia:
      - suffix: ""
        required_params: [chat_id, message_id, media]
        return_type: Message
      - suffix: "Inline"
        required_params: [inline_message_id, media]
        return_type: True
    editMessageLiveLocation:
      - suffix: ""
        required_params: [chat_id, message_id, latitude, longitude]
        return_type: Message
      - suffix: "Inline"
        required_params: [inline_message_id, latitude, longitude]
        return_type: True
    editMessageReplyMarkup:
      - suffix: ""
        required_params: [chat_id, message_id]
        return_type: Message
      - suffix: "Inline"
        required_params: [inline_message_id]
        return_type: True
    stopMessageLiveLocation:
      - suffix: ""
        required_params: [chat_id, message_id]
        return_type: Message
      - suffix: "Inline"
        required_params: [inline_message_id]
        return_type: True

shortcuts:
  bindings:
    MessageUpdate:
      receiver: msg
      params:
        chat_id: msg.Chat
        message_id: msg.ID
    CallbackQueryUpdate:
      receiver: cbq
      params:
        callback_query_id: cbq.ID
        chat_id: cbq.Message.Chat()
        message_id: cbq.Message.MessageID()
    InlineQueryUpdate:
      receiver: iq
      params:
        inline_query_id: iq.ID
    ShippingQueryUpdate:
      receiver: sq
      params:
        shipping_query_id: sq.ID
    PreCheckoutQueryUpdate:
      receiver: pcq
      params:
        pre_checkout_query_id: pcq.ID
    ChatJoinRequestUpdate:
      receiver: joinRequest
      params:
        chat_id: joinRequest.Chat
        user_id: joinRequest.From.ID
    ChatMemberUpdatedUpdate:
      receiver: cmu
      params:
        chat_id: cmu.Chat
        user_id: cmu.From.ID

  methods:
    # === MessageUpdate: Answer* (all send methods â†’ same chat) ===
    - targets: [MessageUpdate]
      method: sendMessage
      helper_name: Answer

    - targets: [MessageUpdate]
      match: "send*"
      helper_prefix: Answer
      exclude: [sendChecklist, sendMessageDraft, sendGame, sendGift, sendDice, sendMessage]

    # === Edit methods on MessageUpdate + CallbackQueryUpdate ===
    - targets: [MessageUpdate, CallbackQueryUpdate]
      match: "editMessage*"
      helper_strip: "Message"
      exclude: [editMessageChecklist, editMessageReplyMarkup]

    # === Message actions ===
    - targets: [MessageUpdate, CallbackQueryUpdate]
      method: deleteMessage
      helper_name: Delete

    - targets: [MessageUpdate]
      method: pinChatMessage
      helper_name: Pin

    - targets: [MessageUpdate]
      method: unpinChatMessage
      helper_name: Unpin

    - targets: [MessageUpdate, CallbackQueryUpdate]
      method: stopMessageLiveLocation
      helper_name: StopLiveLocation

    # === Overrides for special parameter handling ===
    - targets: [MessageUpdate]
      method: sendDice
      helper_name: AnswerDice
      chain: [{ setter: Emoji, param: emoji, type: DiceEmoji }]

    - targets: [MessageUpdate, CallbackQueryUpdate]
      method: editMessageReplyMarkup
      helper_name: EditReplyMarkup
      chain: [{ setter: ReplyMarkup, param: markup, type: InlineKeyboardMarkup }]

    - targets: [MessageUpdate, CallbackQueryUpdate]
      method: setMessageReaction
      helper_name: React
      chain: [{ setter: Reaction, param: reactions, type: "[]ReactionType" }]

    # === Forward/Copy (swapped param bindings) ===
    - targets: [MessageUpdate]
      method: forwardMessage
      helper_name: Forward
      bind: { chat_id: "{to}", from_chat_id: msg.Chat, message_id: msg.ID }

    - targets: [MessageUpdate]
      method: copyMessage
      helper_name: Copy
      bind: { chat_id: "{to}", from_chat_id: msg.Chat, message_id: msg.ID }

    # === Query answers ===
    - targets: [CallbackQueryUpdate]
      method: answerCallbackQuery
      helper_name: Answer

    - targets: [CallbackQueryUpdate]
      method: answerCallbackQuery
      helper_name: AnswerText
      chain:
        - { setter: Text, param: text, type: string }
        - { setter: ShowAlert, param: alert, type: bool }

    - targets: [CallbackQueryUpdate]
      method: answerCallbackQuery
      helper_name: AnswerURL
      chain: [{ setter: URL, param: url, type: string }]

    - targets: [InlineQueryUpdate]
      method: answerInlineQuery
      helper_name: Answer

    - targets: [ShippingQueryUpdate]
      method: answerShippingQuery
      helper_name: Answer

    - targets: [PreCheckoutQueryUpdate]
      method: answerPreCheckoutQuery
      helper_name: Answer

    - targets: [ChatJoinRequestUpdate]
      method: approveChatJoinRequest
      helper_name: Approve

    - targets: [ChatJoinRequestUpdate]
      method: declineChatJoinRequest
      helper_name: Decline

    # === StopPoll ===
    - targets: [MessageUpdate, CallbackQueryUpdate]
      method: stopPoll
      helper_name: StopPoll

    # === Batch delete ===
    - targets: [MessageUpdate]
      method: deleteMessages
      helper_name: DeleteMessages

    # === Moderation (MessageUpdate: binds chat_id) ===
    - targets: [MessageUpdate]
      method: banChatMember
      helper_name: BanMember

    - targets: [MessageUpdate]
      method: unbanChatMember
      helper_name: UnbanMember

    - targets: [MessageUpdate]
      method: restrictChatMember
      helper_name: RestrictMember

    # === Member management (ChatMemberUpdatedUpdate: binds chat_id + user_id) ===
    - targets: [ChatMemberUpdatedUpdate]
      method: banChatMember
      helper_name: Ban

    - targets: [ChatMemberUpdatedUpdate]
      method: unbanChatMember
      helper_name: Unban

    - targets: [ChatMemberUpdatedUpdate]
      method: restrictChatMember
      helper_name: Restrict

    - targets: [ChatMemberUpdatedUpdate]
      method: promoteChatMember
      helper_name: Promote

